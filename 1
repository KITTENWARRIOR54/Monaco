require(['vs/editor/editor.main'], function () {
    updateMonacoTheme();

    require(['vs/basic-languages/lua/lua'], function () {

        editor = monaco.editor.create(document.getElementById('container'), {
            value: '',
            language: 'lua',
            theme: 'CustomTheme',
            fontSize: 15,
            fontFamily: "'Tilt Neon', Consolas, 'Courier New', monospace",
            folding: true,
            dragAndDrop: true,
            links: true,
            minimap: { enabled: true },
            showFoldingControls: 'always',
            smoothScrolling: true,
            cursorBlinking: 'smooth',
            cursorSmoothCaretAnimation: 'on',
            foldingHighlight: true,
            fontLigatures: true,
            formatOnPaste: true,
            showDeprecated: true,
            suggest: { snippetsPreventQuickSuggestions: false },
            padding: { top: 5, left: 0 },
            lineNumbers: 'on',
            lineNumbersMinChars: 3,
            scrollBeyondLastLine: false
        });

        editor.getModel().updateOptions({ insertSpaces: false });

        editor.onDidChangeModelContent(() => {
            if (activeTab) {
                activeTab.content = editor.getValue();
                saveTabsToLocalStorage();
            }
        });

        document.getElementById('new-tab-btn')
            .addEventListener('click', createNewTab);

        loadTabsFromLocalStorage();

        window.onresize = function () {
            editor.layout();
        };

        window.GetText = function () {
            return editor.getValue();
        };

        window.SetText = function (x) {
            editor.setValue(String(x));
            if (activeTab) {
                activeTab.content = editor.getValue();
                saveTabsToLocalStorage();
            }
        };
    });

    window.addEventListener('load', () => {
        setupMessageHandlers();
        setTimeout(() => showToast('Voly loaded!', 'success'), 1500);
    });
});
